-- 1. Создание базы данных
DROP DATABASE IF EXISTS SoftKeyDB;
CREATE DATABASE SoftKeyDB;
USE SoftKeyDB;

-- 2. Таблица: Роли (для разделения Админа и Клиента)
CREATE TABLE Роли (
    ID_Роли INT PRIMARY KEY AUTO_INCREMENT,
    Название VARCHAR(50) NOT NULL
);

-- 3. Таблица: Пользователи
CREATE TABLE Пользователи (
    ID_Пользователя INT PRIMARY KEY AUTO_INCREMENT,
    
    Фамилия VARCHAR(50) NOT NULL,
    Имя VARCHAR(50),
    Отчество VARCHAR(50),
    
    Телефон VARCHAR(20) UNIQUE,
    Дата_рождения DATE,
    Логин VARCHAR(50) NOT NULL UNIQUE,
    Пароль VARCHAR(255) NOT NULL,
    ID_Роли INT,
    
    Дата_регистрации TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ID_Роли) REFERENCES Роли(ID_Роли)
);

-- 4. Таблица: Категории товаров
CREATE TABLE Категории (
    ID_Категории INT PRIMARY KEY AUTO_INCREMENT,
    Название_категории VARCHAR(100) NOT NULL
);

-- 5. Таблица: Товары (Витрина)
CREATE TABLE Товары (
    ID_Товара INT PRIMARY KEY AUTO_INCREMENT,
    Название VARCHAR(255) NOT NULL,
    Описание TEXT,
    Цена DECIMAL(10, 2) NOT NULL,
    ID_Категории INT,
    Изображение VARCHAR(255) DEFAULT 'default.jpg',
    Статус_активности BOOLEAN NOT NULL DEFAULT 1,
    FOREIGN KEY (ID_Категории) REFERENCES Категории(ID_Категории)
);

-- 6. Таблица: Корзина (Временные данные)
CREATE TABLE Корзина (
    ID_Корзины INT PRIMARY KEY AUTO_INCREMENT,
    ID_Пользователя INT,
    ID_Товара INT,
    Количество INT DEFAULT 1,
    FOREIGN KEY (ID_Пользователя) REFERENCES Пользователи(ID_Пользователя),
    FOREIGN KEY (ID_Товара) REFERENCES Товары(ID_Товара)
);

-- 7. Таблица: Заказы (Общая информация о покупке)
CREATE TABLE Заказы (
    ID_Заказа INT PRIMARY KEY AUTO_INCREMENT,
    ID_Пользователя INT,
    Дата_заказа DATETIME DEFAULT CURRENT_TIMESTAMP,
    Статус VARCHAR(50) DEFAULT 'Новый',
    Итоговая_сумма DECIMAL(10, 2),
    FOREIGN KEY (ID_Пользователя) REFERENCES Пользователи(ID_Пользователя)
);

-- 8. Таблица: Состав_заказа (Здесь фиксируется цена и срок на момент покупки)
CREATE TABLE Состав_заказа (
    ID_Позиции INT PRIMARY KEY AUTO_INCREMENT,
    ID_Заказа INT,
    ID_Товара INT,
    Цена_продажи DECIMAL(10, 2) NOT NULL, -- Цена может измениться в магазине, но в заказе она останется прежней
    Срок_лицензии_дни INT NOT NULL,       -- Например: 30, 365 или 9999 (бессрочно)
    Количество INT NOT NULL,
    FOREIGN KEY (ID_Заказа) REFERENCES Заказы(ID_Заказа),
    FOREIGN KEY (ID_Товара) REFERENCES Товары(ID_Товара)
);

-- 9. Таблица: Лицензии (Результат покупки — ключи)
CREATE TABLE Лицензии (
    ID_Лицензии INT PRIMARY KEY AUTO_INCREMENT,
    ID_Позиции_заказа INT,
    Лицензионный_ключ VARCHAR(100) NOT NULL,
    Дата_активации DATETIME,
    Дата_истечения DATETIME,
    FOREIGN KEY (ID_Позиции_заказа) REFERENCES Состав_заказа (ID_Позиции)
);

-- ==========================================================
-- (Триггеры и Процедуры)
-- ==========================================================

-- Триггер для расчета итоговой суммы заказа
DELIMITER //

CREATE TRIGGER Расчет_итоговой_суммы
BEFORE INSERT ON Заказы
FOR EACH ROW
BEGIN
    DECLARE v_сумма DECIMAL(10,2);
    
    -- Если сумма не указана
    IF NEW.Итоговая_сумма IS NULL THEN
        SET NEW.Итоговая_сумма = 0.00;
    END IF;
    
    -- Проверяем, что сумма не отрицательная
    IF NEW.Итоговая_сумма < 0 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'Итоговая сумма не может быть отрицательной';
    END IF;
END //

DELIMITER ;	

-- ПРОЦЕДУРА: Оформление заказа из корзины
-- Эта процедура переносит всё из корзины в заказ и очищает корзину
DELIMITER //
CREATE PROCEDURE ОформитьЗаказ(IN p_ID_Пользователя INT, IN p_Срок INT)
BEGIN
    DECLARE v_ID_Заказа INT;
    DECLARE v_Total DECIMAL(10,2);
    
    -- Считаем общую сумму в корзине
    SELECT SUM(Т.Цена * К.Количество) INTO v_Total
    FROM Корзина К JOIN Товары Т ON К.ID_Товара = Т.ID_Товара
    WHERE К.ID_Пользователя = p_ID_Пользователя;
    
    -- Создаем запись в Заказах
    INSERT INTO Заказы (ID_Пользователя, Итоговая_сумма, Статус) 
    VALUES (p_ID_Пользователя, v_Total, 'Оплачен');
    
    SET v_ID_Заказа = LAST_INSERT_ID();
    
    -- Переносим товары из корзины в Состав_заказа
    INSERT INTO Состав_заказа (ID_Заказа, ID_Товара, Цена_продажи, Срок_лицензии_дни, Количество)
    SELECT v_ID_Заказа, ID_Товара, 
           (SELECT Цена FROM Товары WHERE ID_Товара = Корзина.ID_Товара), 
           p_Срок, Количество
    FROM Корзина WHERE ID_Пользователя = p_ID_Пользователя;
    
    -- Очищаем корзину
    DELETE FROM Корзина WHERE ID_Пользователя = p_ID_Пользователя;
END //
DELIMITER ;

-- ==========================================================
-- Тестовые данные
-- ==========================================================

-- 1. Заполняем Роли
INSERT INTO Роли (Название) VALUES ('Администратор'), ('Клиент');

-- 2. Заполняем Пользователей (с учетом твоих исправлений)
-- Пароли в учебных проектах обычно хранят в открытом виде или простом хеше
INSERT INTO Пользователи (Фамилия, Имя, Отчество, Логин, Пароль, ID_Роли) VALUES 
('Иванов', 'Иван', 'Иванович', 'admin@key.ru', 'admin123', 1),
('Петров', 'Алексей', 'Сергеевич', 'petrov_as@key.ru', 'password55', 2),
('Сидорова', 'Мария', 'Павловна', 'masha_99@key.ru', '123456', 2);

-- 3. Заполняем Категории
INSERT INTO Категории (Название_категории) VALUES 
('Операционные системы'), 
('Офисные программы'), 
('Антивирусы'), 
('Графические редакторы');

-- 4. Заполняем Товары
INSERT INTO Товары (Название, Описание, Цена, ID_Категории) VALUES 
('Windows 11 Pro', 'Windows 11 Pro — это современная операционная система для профессионального использования с улучшенным интерфейсом и расширенными функциями безопасности. Система предлагает переработанное меню "Пуск", центрированную панель задач, виджеты для быстрого доступа к информации и улучшенную поддержку многозадачности с функциями Snap Layouts и Snap Groups.

Ключевые особенности:
• Повышенная безопасность с аппаратной изоляцией, безопасной загрузкой и Microsoft Defender
• DirectStorage для ускорения загрузки игр
• Auto HDR для улучшения качества изображения в играх
• Виртуальные рабочие столы для организации различных рабочих процессов
• Нативная поддержка приложений Android через Amazon Appstore
• Улучшенная интеграция с Microsoft Teams

Требования к системе:
Процессор: 1 ГГц или быстрее с 2+ ядрами, 64-битный
ОЗУ: 4 ГБ и выше
Хранилище: 64 ГБ и выше
Видеокарта: DirectX 12 совместимая с WDDM 2.0 драйвером
Безопасная загрузка и TPM 2.0', 15000.00, 1),

('Microsoft Office 2021', 'Microsoft Office 2021 Professional помогает создать единую среду для бизнеса и коммуникации, повысить производительность и эффективность работы за счет облачных технологий. Пользователи могут совместно создавать, редактировать, просматривать документы и вносить правки с любого устройства.

Офис профессиональный включает приложения версии для дома и бизнеса и дополнен новыми программами. В комплектацию входят:
• Word – текстовый редактор с улучшенными функциями совместной работы
• Excel – программа для работы с таблицами с новыми функциями анализа данных
• PowerPoint для подготовки интерактивных презентаций
• OneNote для создания цифровых заметок и организации информации
• Outlook – менеджер-органайзер с функциями почтового клиента и календаря
• Publisher – программа для создания качественных публикаций и маркетинговых материалов
• Access – приложение для работы с базами данных

Новые функции Office 2021:
• Динамические массивы в Excel
• XLOOKUP функция в Excel
• Улучшенная темизация в PowerPoint
• Функция "Диктор" в Word
• Интеграция с Microsoft Teams
• Локальное сохранение данных (без обязательной облачной подписки)

Требования к системе:
Процессор: 2 ГГц и выше
Операционная система: Windows 10/11
Места на диске: 4 ГБ
Оперативная память: 4 ГБ и выше
Видеопамять: 4 ГБ и выше
DirectX: 10', 12000.00, 2),

('Kaspersky Total Security', 'Kaspersky Total Security — комплексное решение для защиты на 1 год для 2 устройств, обеспечивающее безопасность от всех типов угроз в интернете и офлайн. Продукт сочетает в себе антивирусную защиту, файервол, защиту от фишинга и дополнительные функции для обеспечения приватности.

Основные функции:
• Защита от вирусов, троянов, шпионского ПО и ransomware
• Файервол для контроля сетевой активности
• Защита онлайн-платежей и банковских операций
• Менеджер паролей для безопасного хранения учетных данных
• Родительский контроль с настройкой времени использования
• Защита веб-камеры от несанкционированного доступа
• VPN с ограниченным трафиком (200 МБ/день)
• Резервное копирование важных файлов в облако

Преимущества:
• Многоуровневая защита без замедления работы системы
• Проактивная защита от новых угроз
• Автоматическое обновление баз данных
• Круглосуточная техническая поддержка
• Совместимость с Windows, macOS, Android и iOS

Системные требования для Windows:
ОС: Windows 7/8/8.1/10/11 (32/64-bit)
ОЗУ: 1 ГБ (32-bit) или 2 ГБ (64-bit)
Свободное место: 1.5 ГБ
Интернет: для активации и обновлений', 1800.00, 3),

('Adobe Photoshop', 'Adobe Photoshop — профессиональный графический редактор и подписка на облачный сервис для работы с растровой графикой. Индустриальный стандарт для фотографов, дизайнеров, иллюстраторов и специалистов по обработке изображений.

Возможности:
• Профессиональная ретушь фотографий и цветокоррекция
• Работа со слоями, масками и каналами
• Интеллектуальные инструменты выделения (Select Subject, Object Selection)
• Искусственный интеллект Adobe Sensei для автоматизации задач
• 3D-моделирование и текстурирование
• Анимация и создание GIF
• Поддержка RAW-форматов фотокамер
• Интеграция с другими приложениями Adobe Creative Cloud

Новые функции последней версии:
• Neural Filters для AI-обработки фотографий
• Sky Replacement для автоматической замены неба
• Enhance Portrait для улучшения портретов
• Pattern Preview для создания бесшовных текстур
• Облачные документы для работы на разных устройствах
• Прямая интеграция с Adobe Stock

Требования к системе:
Процессор: Intel или AMD с поддержкой 64-bit
ОС: Windows 10 (версия 1909 или новее)
ОЗУ: 8 ГБ (рекомендуется 16 ГБ)
Видеокарта: DirectX 12, 2 ГБ видеопамяти
Свободное место: 4 ГБ для установки
Разрешение монитора: 1280x800 (рекомендуется 1920x1080)', 35000.00, 4),

('Dr.Web Desktop Security', 'Dr.Web Desktop Security — антивирус для дома на 6 месяцев, обеспечивающий комплексную защиту от вредоносного ПО, шпионских программ, рекламного ПО и сетевых угроз. Российская разработка с более чем 25-летним опытом в области кибербезопасности.

Основные компоненты:
• Антивирусный сканер с ежедневными обновлениями
• Проактивная защита от неизвестных угроз
• Файервол для контроля сетевых подключений
• Антиспам фильтр для почтовых клиентов
• Родительский контроль с ограничением времени
• Защита от фишинговых сайтов
• Предотвращение краж данных
• Мониторинг процессов в реальном времени

Уникальные технологии Dr.Web:
• Origins Tracing™ для лечения зараженных файлов
• Fly-Code для распаковки сложных упаковщиков
• SelfProtect для защиты от выключения антивируса
• Нативная поддержка русского языка
• Минимальное потребление системных ресурсов

Системные требования:
ОС: Windows 7/8/8.1/10/11 (32/64-bit)
Процессор: 1 ГГц или выше
ОЗУ: 512 МБ (32-bit) или 1 ГБ (64-bit)
Свободное место: 650 МБ
Интернет-соединение: для активации и обновлений
Дополнительно: мышь, клавиатура, CD/DVD привод (для коробочной версии)', 900.00, 3);

-- 5. Тестовая Корзина (Петров положил товар, но еще не купил)
INSERT INTO Корзина (ID_Пользователя, ID_Товара, Количество) VALUES 
(2, 3, 1), -- Петров хочет Касперский
(2, 1, 1); -- Петров хочет Windows

-- 6. Оформленный Заказ (Сидорова уже совершила покупку)
-- Сначала создаем "шапку" заказа
INSERT INTO Заказы (ID_Пользователя, Дата_заказа, Статус, Итоговая_сумма) VALUES 
(3, '2024-05-20 14:30:00', 'Оплачен', 12900.00);

-- 7. Состав заказа для Сидоровой (купила Office и Dr.Webзаказы)
-- Предположим, ID заказа получился = 1
INSERT INTO Состав_заказа (ID_Заказа, ID_Товара, Цена_продажи, Срок_лицензии_дни, Количество) VALUES 
(1, 2, 12000.00, 9999, 1), -- Office (бессрочно)
(1, 5, 900.00, 180, 1);    -- Dr.Web (на 6 месяцев)

-- 8. Генерация ключей для купленных лицензий
-- Привязываем к позициям из Состава_заказа (ID 1 и 2)
INSERT INTO Лицензии (ID_Позиции_заказа, Лицензионный_ключ, Дата_активации, Дата_истечения) VALUES 
(1, 'OFF-2021-XXXX-YYYY-ZZZZ', '2024-05-20 15:00:00', '2099-12-31 23:59:59'),
(2, 'DRWEB-6MO-AAAA-BBBB-CCCC', '2024-05-20 15:00:00', '2024-11-20 15:00:00');